<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3UN9V6N5VPR1c8UxMIVGG_NgQeiDCsSU",
        authDomain: "monetah-e9223.firebaseapp.com",
        projectId: "monetah-e9223",
        storageBucket: "monetah-e9223.firebasestorage.app",
        messagingSenderId: "378947912923",
        appId: "1:378947912923:web:ea5be84fd77ea39ac378fe"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let balance = 0;

    // অটো ইন-অ্যাপ অ্যাড
    window.onload = () => { 
        if(typeof show_10618893 === 'function') 
            show_10618893({ type: 'inApp' }); 
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-email').innerText = user.email;
            fetchData(user.uid);
        } else {
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
        }
    });

    async function fetchData(uid) {
        const snap = await getDoc(doc(db, "users", uid));
        if (snap.exists()) {
            balance = snap.data().balance;
            document.getElementById('user-balance').innerText = balance.toFixed(3);
        }
    }

    // অ্যাড ফাংশন (Popup বাদ, Direct Link ব্যবহার)
    window.playAd = (type) => {
        if (type === 'video') {
            show_10618890()
                .then(() => addReward(0.005))
                .catch(() => alert("অ্যাড পুরোপুরি শেষ করুন।"));
        } else {
            // Popup Ad বাদ
            window.open("https://omg10.com/4/10618909", "_blank");

            // Reward যোগ
            addReward(0.003);
        }
    };

    async function addReward(amt) {
        if (auth.currentUser) {
            await updateDoc(
                doc(db, "users", auth.currentUser.uid), 
                { balance: increment(amt) }
            );
            fetchData(auth.currentUser.uid);
            alert("ব্যালেন্স যোগ হয়েছে!");
        }
    }

    // উইথড্র ফাংশন
    window.toggleWithdraw = () => {
        const s = document.getElementById('withdraw-section');
        s.style.display = s.style.display === 'block' ? 'none' : 'block';
    };

    window.submitWithdraw = async () => {
        const amt = parseFloat(document.getElementById('w-amount').value);
        const num = document.getElementById('w-number').value;

        if (amt >= 1.0 && amt <= balance && num) {
            try {
                await addDoc(collection(db, "withdrawals"), {
                    uid: auth.currentUser.uid,
                    email: auth.currentUser.email,
                    amount: amt,
                    method: document.getElementById('w-method').value,
                    number: num,
                    status: "Pending",
                    time: serverTimestamp()
                });

                await updateDoc(
                    doc(db, "users", auth.currentUser.uid), 
                    { balance: increment(-amt) }
                );

                fetchData(auth.currentUser.uid);
                alert("Withdraw Request Sent Success!");

            } catch (e) {
                alert("Error sending request.");
            }
        } else {
            alert("ব্যালেন্স কম বা ভুল তথ্য দিয়েছেন (Min $1.0)");
        }
    };

    // Auth ফাংশন
    window.handleSignUp = async () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;

        try {
            const res = await createUserWithEmailAndPassword(auth, e, p);
            await setDoc(
                doc(db, "users", res.user.uid), 
                { balance: 0.0, email: e }
            );
        } catch (err) { 
            alert(err.message); 
        }
    };

    window.handleLogin = async () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;

        try { 
            await signInWithEmailAndPassword(auth, e, p); 
        } catch (err) { 
            alert("Login failed!"); 
        }
    };

    window.logout = () => signOut(auth);
        </script>
